################################################################################
# MinIO Enterprise Backup Configuration
#
# This file contains configuration settings for automated backups.
# Source this file in your backup scripts or use it with the backup scheduler.
#
################################################################################

# ============================================================================
# BACKUP CONFIGURATION
# ============================================================================

# Backup type: full or incremental
BACKUP_TYPE="full"

# Backup destination directory
# Ensure this directory exists and has sufficient space
BACKUP_DEST="/backup"

# Enable compression (true/false)
# Compression reduces backup size but increases CPU usage
COMPRESS=true

# Enable encryption (true/false)
# Requires GPG key file to be configured
ENCRYPT=false

# GPG key file path (required if ENCRYPT=true)
# Generate a key with: gpg --gen-key
GPG_KEY_FILE=""

# Backup retention period in days
# Backups older than this will be automatically deleted
RETENTION_DAYS=30

# Enable backup verification after creation (true/false)
# Verification ensures backup integrity but takes additional time
VERIFY=true

# ============================================================================
# BACKUP SCHEDULE
# ============================================================================

# Full backup schedule (cron format)
# Default: Daily at 2:00 AM
FULL_BACKUP_SCHEDULE="0 2 * * *"

# Incremental backup schedule (cron format)
# Default: Every 6 hours (at 00:00, 06:00, 12:00, 18:00)
INCREMENTAL_BACKUP_SCHEDULE="0 */6 * * *"

# ============================================================================
# COMPONENT SELECTION
# ============================================================================

# Enable/disable backup for specific components
BACKUP_MINIO=true
BACKUP_POSTGRESQL=true
BACKUP_REDIS=true
BACKUP_CONFIGS=true

# ============================================================================
# NOTIFICATION SETTINGS
# ============================================================================

# Enable email notifications (true/false)
EMAIL_NOTIFICATIONS=false

# Email recipients (comma-separated)
EMAIL_RECIPIENTS="admin@example.com,ops@example.com"

# SMTP server settings
SMTP_SERVER="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="backup@example.com"
SMTP_PASSWORD=""

# Enable Slack notifications (true/false)
SLACK_NOTIFICATIONS=false

# Slack webhook URL
SLACK_WEBHOOK_URL=""

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Parallel backup jobs
# Number of backup operations to run in parallel (1-4 recommended)
PARALLEL_JOBS=2

# Temporary directory for backup staging
TEMP_DIR="/tmp/minio_backup"

# Maximum backup size in GB (warning threshold)
MAX_BACKUP_SIZE_GB=100

# Backup file naming pattern
# Available variables: {type}, {timestamp}, {date}, {hostname}
BACKUP_NAME_PATTERN="minio_backup_{type}_{timestamp}"

# ============================================================================
# STORAGE BACKEND SETTINGS
# ============================================================================

# Storage backend: local, s3, or both
STORAGE_BACKEND="local"

# S3-compatible storage settings (if STORAGE_BACKEND includes "s3")
S3_ENDPOINT="https://s3.amazonaws.com"
S3_BUCKET="minio-backups"
S3_ACCESS_KEY=""
S3_SECRET_KEY=""
S3_REGION="us-east-1"

# ============================================================================
# DOCKER SETTINGS
# ============================================================================

# Docker Compose file path
DOCKER_COMPOSE_FILE="deployments/docker/docker-compose.production.yml"

# Docker network name
DOCKER_NETWORK="minio-network"

# ============================================================================
# LOGGING SETTINGS
# ============================================================================

# Log file path
LOG_FILE="/var/log/minio_backup.log"

# Log level: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL="INFO"

# Enable syslog (true/false)
ENABLE_SYSLOG=false

# Syslog facility
SYSLOG_FACILITY="local0"

# ============================================================================
# RETENTION POLICY
# ============================================================================

# Keep last N full backups regardless of age
KEEP_LAST_FULL_BACKUPS=7

# Keep last N incremental backups regardless of age
KEEP_LAST_INCREMENTAL_BACKUPS=28

# Minimum free space in backup destination (GB)
MIN_FREE_SPACE_GB=50

# ============================================================================
# MAINTENANCE SETTINGS
# ============================================================================

# Run backup integrity check weekly (true/false)
WEEKLY_INTEGRITY_CHECK=true

# Day of week for integrity check (0-6, 0=Sunday)
INTEGRITY_CHECK_DAY=0

# Time for integrity check (HH:MM)
INTEGRITY_CHECK_TIME="03:00"

# ============================================================================
# DISASTER RECOVERY SETTINGS
# ============================================================================

# Enable offsite backup replication (true/false)
OFFSITE_REPLICATION=false

# Offsite backup location (rsync destination)
OFFSITE_DESTINATION="user@backup-server:/mnt/backups/minio/"

# SSH key for offsite replication
OFFSITE_SSH_KEY="/root/.ssh/backup_id_rsa"

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# I/O niceness (0-7, higher = lower priority)
# Reduces impact on production workload
IO_NICE=5

# CPU niceness (0-19, higher = lower priority)
CPU_NICE=10

# Network bandwidth limit (KB/s, 0 = unlimited)
# Useful for offsite replication
BANDWIDTH_LIMIT=0

# ============================================================================
# COMPLIANCE SETTINGS
# ============================================================================

# Enable audit logging (true/false)
AUDIT_LOGGING=true

# Audit log file path
AUDIT_LOG_FILE="/var/log/minio_backup_audit.log"

# Enable backup metadata collection (true/false)
# Collects detailed information about each backup
COLLECT_METADATA=true

# Metadata file format: json or yaml
METADATA_FORMAT="json"

################################################################################
# END OF CONFIGURATION
################################################################################

# DO NOT EDIT BELOW THIS LINE

# Validate configuration on source
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    # Configuration is being sourced
    if [[ "$ENCRYPT" == true ]] && [[ -z "$GPG_KEY_FILE" ]]; then
        echo "ERROR: Encryption enabled but GPG_KEY_FILE not set" >&2
        return 1
    fi

    if [[ ! -d "$BACKUP_DEST" ]]; then
        echo "WARNING: Backup destination does not exist: $BACKUP_DEST" >&2
        echo "Creating directory..." >&2
        mkdir -p "$BACKUP_DEST" 2>/dev/null || {
            echo "ERROR: Failed to create backup destination" >&2
            return 1
        }
    fi
fi
